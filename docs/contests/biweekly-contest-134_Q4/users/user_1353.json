{
    "username": "yumkam",
    "submission": "static constexpr unsigned bits = 31;\nclass Solution {\npublic:\n    long long countSubarrays(vector<int>& nums, int k) {\n        const unsigned n = nums.size();\n        vector<array<unsigned, bits>> cntbits(n + 1);\n        array<unsigned, bits> cnt {};\n        for (unsigned i = 0; i < n; ++i) {\n            auto num = nums[i];\n            for (unsigned bit = 0; num; ++bit, num >>= 1)\n                cnt[bit] += num & 1;\n            cntbits[i + 1] = cnt;\n        }\n        auto andsum = [&](auto l, auto r) { // nums[l] & ... & nums[r]\n            int ret = 0;\n            for (unsigned bit = 0, bm = 1; bit < bits; ++bit, bm <<= 1)\n                if (cntbits[r + 1][bit] - cntbits[l][bit] == r - l + 1)\n                    ret |= bm;\n            return ret;\n        };\n        auto countbits = [k](auto v) {\n            unsigned missing = 0;\n            unsigned extra = 0;\n            for (unsigned i = 0, mask = 1; i < bits; ++i, mask <<= 1) {\n                if ((v & mask) && !(k & mask))\n                    ++extra;\n                if (!(v & mask) && (k & mask))\n                    ++missing;\n            }\n            return pair { missing, extra };\n        };\n        long long ret = 0;\n        for (unsigned i = 0; i < n; ++i) {\n            //assert(andsum(i, i) == nums[i]);\n            {\n                auto [miss, ex] = countbits(nums[i]);\n                if (miss)\n                    continue;\n            }\n            {\n                auto [miss, ex] = countbits(andsum(0, i));\n                if (ex)\n                    continue;\n            }\n            unsigned a;\n            // look for first index such that andsum(a, i) does not have missing bits\n            {\n                unsigned lo = 0;\n                unsigned hi = i;\n                while(lo < hi) {\n                    unsigned mid = lo + (hi - lo)/2;\n                    auto s = andsum(mid, i);\n                    auto [miss, ex] = countbits(s);\n                    if (miss)\n                        lo = mid + 1;\n                    else\n                        hi = mid;\n                }\n                a = lo;\n            }\n            {\n                auto [miss, ex] = countbits(andsum(a, i));\n                if (ex)\n                    continue;\n            }\n            // look for last index that has no extra bits\n            unsigned b;\n            {\n                unsigned lo = a;\n                unsigned hi = i;\n                while(lo < hi) {\n                    unsigned mid = lo + (hi - lo + 1)/2;\n                    auto s = andsum(mid, i);\n                    auto [miss, ex] = countbits(s);\n                    if (ex)\n                        hi = mid - 1;\n                    else\n                        lo = mid;\n                }\n                b = lo;\n            }\n            ret += b - a + 1;\n        }\n        return ret;        \n    }\n};",
    "submit_ts": "1720279293",
    "subm_id": "1311745424"
}