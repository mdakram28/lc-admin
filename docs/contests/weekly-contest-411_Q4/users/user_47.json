{
    "username": "Ernest Lu",
    "submission": "using ll = long long;\ntemplate <typename T> struct fen {\n  vector<T> tr;\n  ll mxn;\n\n  fen(ll sz) {\n    mxn = sz;\n    tr.assign(sz + 5, 0);\n  }\n\n  void upd(ll g, T k) {\n    g++;\n    assert(g != 0);\n    for (; g <= mxn; g += g & -g)\n      tr[g] += k;\n  }\n\n  T ge(ll g) {\n    g++;\n    T res = 0;\n    for (; g; g -= g & -g)\n      res += tr[g];\n    return res;\n  }\n\n  T rng(ll l, ll r) { return ge(r) - ge(l - 1); }\n};\n#define pb push_back\nclass Solution {\npublic:\n    vector<long long> countKConstraintSubstrings(string s, int k,\n                                             vector<vector<int>> &queries) {\n  auto &q = queries;\n\n  int n = (int)s.size();\n  vector f(2, vector<int>(n, 0));\n  for (int i = 0; i < n; i++) {\n    f[s[i] - '0'][i]++;\n    if (i)\n      f[0][i] += f[0][i - 1], f[1][i] += f[1][i - 1];\n  }\n\n  auto range_q = [&](int z, int l, int r) -> int {\n    return f[z][r] - (l == 0 ? 0 : f[z][l - 1]);\n  };\n\n  vector<int> rp(n, 0);\n  for (int i = 0; i < n; i++) {\n    int lo = i, hi = n - 1;\n    while (lo < hi) {\n      int mid = (lo + hi + 1) >> 1;\n      if (range_q(0, i, mid) <= k or range_q(1, i, mid) <= k)\n        lo = mid;\n      else\n        hi = mid - 1;\n    }\n    rp[i] = lo;\n  }\n\n  vector query_process(n, vector<int>());\n  for (int i = 0; i < (int)q.size(); i++) {\n    query_process[q[i][1]].push_back(i);\n  }\n  vector<ll> ans(q.size());\n\n  vector exit_bin(n, vector<int>());\n  for (int i = 0; i < n; i++)\n    exit_bin[rp[i]].pb(i);\n\n  fen<ll> tree(n), active(n), active_l(n);\n  for (int i = 0; i < n; i++) {\n    active.upd(i, 1);\n    active_l.upd(i, i - 1);\n\n    for (const auto &qid : query_process[i]) {\n      ll l = q[qid][0], r = q[qid][1];\n      ans[qid] = tree.rng(l, r) + active.rng(l, r) * r - active_l.rng(l, r);\n    }\n    for (const auto &l : exit_bin[i]) {\n      active.upd(l, -1);\n      active_l.upd(l, -(l - 1));\n      tree.upd(l, rp[l] - l + 1);\n    }\n  }\n\n  return ans;\n}\n};",
    "submit_ts": "1723951389",
    "subm_id": "1359770367"
}